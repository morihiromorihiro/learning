<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>現在地マップアプリ</title>
    <!-- Tailwind CSS CDNの読み込み -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Interフォントの設定 -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
        #map {
            /* 地図コンテナのサイズを決定 */
            height: 70vh; /* ビューポートの高さの70% */
            width: 100%;
            border-radius: 0.75rem; /* rounded-xl */
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
    </style>
    <!-- Leaflet (地図ライブラリ) のCSSとJSを読み込み -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha236-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
        crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha236-F5QbbDp/5q5+j9J/Q6S6L2+S5Q0/5l9J5/v+R2Q0/5J9="
        crossorigin=""></script>
</head>
<body class="p-4 sm:p-8 min-h-screen flex flex-col items-center">

    <div class="w-full max-w-4xl bg-white p-6 sm:p-8 rounded-2xl shadow-xl">

        <h1 class="text-3xl font-extrabold text-gray-900 mb-2">現在地マップ</h1>
        <p class="text-gray-600 mb-6">ボタンを押して、あなたの現在の位置情報を地図上に表示します。</p>

        <!-- ステータス/情報表示エリア -->
        <div id="status-box" class="mb-6 p-4 rounded-lg bg-indigo-50 border border-indigo-200 text-indigo-700 font-medium">
            位置情報取得ボタンを押してください。
        </div>

        <!-- ボタン -->
        <button id="get-location-btn"
                class="w-full sm:w-auto px-6 py-3 bg-indigo-600 text-white font-bold rounded-lg hover:bg-indigo-700 transition duration-150 ease-in-out shadow-md hover:shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-500/50 flex items-center justify-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.828 0l-4.243-4.243a8 8 0 1111.314 0z"></path>
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z"></path>
            </svg>
            <span>現在地を取得＆表示</span>
        </button>

        <!-- 地図コンテナ -->
        <div id="map" class="mt-6"></div>

        <!-- 緯度経度表示エリア -->
        <div class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4">
            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm font-semibold text-gray-500">緯度 (Latitude)</p>
                <p id="latitude-display" class="text-xl font-bold text-gray-800">--</p>
            </div>
            <div class="p-3 bg-gray-50 rounded-lg border border-gray-200">
                <p class="text-sm font-semibold text-gray-500">経度 (Longitude)</p>
                <p id="longitude-display" class="text-xl font-bold text-gray-800">--</p>
            </div>
        </div>
    </div>

    <script>
        // DOM要素の取得
        const statusBox = document.getElementById('status-box');
        const getLocationBtn = document.getElementById('get-location-btn');
        const latitudeDisplay = document.getElementById('latitude-display');
        const longitudeDisplay = document.getElementById('longitude-display');

        // Leafletマップの初期化
        // 初期ビューは世界全体 (ズームレベル2)
        const map = L.map('map').setView([0, 0], 2);

        // OpenStreetMapのタイルレイヤーを追加
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            // 著作権表示は必須
            attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // マーカーを初期位置 (0, 0) に設定
        let marker = L.marker([0, 0]).addTo(map)
            .bindPopup('現在地')
            .openPopup();

        /**
         * ステータスボックスの表示を更新する関数
         * @param {string} message - 表示するメッセージ
         * @param {string} type - 'info', 'error', 'loading' に基づいてスタイルを変更
         */
        function updateStatus(message, type = 'info') {
            statusBox.textContent = message;
            statusBox.className = "mb-6 p-4 rounded-lg font-medium";

            if (type === 'error') {
                statusBox.classList.add('bg-red-50', 'border-red-200', 'text-red-700');
            } else if (type === 'loading') {
                statusBox.classList.add('bg-yellow-50', 'border-yellow-200', 'text-yellow-700');
            } else { // info
                statusBox.classList.add('bg-indigo-50', 'border-indigo-200', 'text-indigo-700');
            }
        }

        /**
         * 緯度経度表示を更新する関数
         * @param {number|string} lat - 緯度
         * @param {number|string} lon - 経度
         */
        function updateCoordinates(lat, lon) {
            latitudeDisplay.textContent = lat !== null ? lat.toFixed(6) : '--';
            longitudeDisplay.textContent = lon !== null ? lon.toFixed(6) : '--';
        }

        /**
         * Geolocation API成功時のコールバック関数
         * @param {Position} position - 取得された位置情報オブジェクト
         */
        function success(position) {
            const latitude = position.coords.latitude;
            const longitude = position.coords.longitude;

            // 1. マーカーと地図の更新
            const latLng = [latitude, longitude];
            marker.setLatLng(latLng)
                .setPopupContent(`現在地: ${latitude.toFixed(4)}, ${longitude.toFixed(4)}`)
                .openPopup();

            // 地図のビューを現在地に移動し、ズームレベルを調整 (例: 13)
            map.setView(latLng, 13);

            // 2. ステータスの更新
            updateStatus('位置情報の取得に成功しました。地図と座標を確認してください。', 'info');

            // 3. 座標表示の更新
            updateCoordinates(latitude, longitude);

            // ボタンを再度有効化
            getLocationBtn.disabled = false;
        }

        /**
         * Geolocation API失敗時のコールバック関数
         * @param {PositionError} error - エラーオブジェクト
         */
        function error(error) {
            let message = '位置情報の取得に失敗しました。';
            switch(error.code) {
                case error.PERMISSION_DENIED:
                    message += '（ユーザーが位置情報へのアクセスを拒否しました。）';
                    break;
                case error.POSITION_UNAVAILABLE:
                    message += '（位置情報を取得できませんでした。）';
                    break;
                case error.TIMEOUT:
                    message += '（タイムアウトしました。）';
                    break;
                case error.UNKNOWN_ERROR:
                    message += '（不明なエラーが発生しました。）';
                    break;
            }
            updateStatus(message, 'error');
            // 座標表示をリセット
            updateCoordinates('--', '--');
            // ボタンを再度有効化
            getLocationBtn.disabled = false;
        }

        /**
         * 位置情報取得を開始する関数
         */
        function getLocation() {
            if (!navigator.geolocation) {
                updateStatus('お使いのブラウザは位置情報サービスに対応していません。', 'error');
                return;
            }

            // ボタンを無効化し、ローディング状態を表示
            getLocationBtn.disabled = true;
            updateStatus('位置情報を取得中です...', 'loading');
            updateCoordinates('取得中...', '取得中...');

            // 位置情報取得オプション
            const options = {
                enableHighAccuracy: true, // 高精度な位置情報を要求
                timeout: 5000,          // タイムアウト (5秒)
                maximumAge: 0           // キャッシュされた位置情報を使わない
            };

            // 位置情報の取得開始
            navigator.geolocation.getCurrentPosition(success, error, options);
        }

        // ボタンクリックイベントリスナーの設定
        getLocationBtn.addEventListener('click', getLocation);

        // アプリ起動時に一度だけ、地図のサイズが正しく反映されるようにする
        // (特にTailwindや動的なサイズ変更がある場合に重要)
        window.onload = () => {
             map.invalidateSize();
        };

    </script>
</body>
</html>
